# Data Modeling for RDBMS (in Japanese)

## 学習メモ（自分用）

個人的に必要な箇所をメモ書きする．大括弧[]は，11節の各見出しに対応．


### [人のテーブルを作ろう]

まずは，一意である情報に主キーを設定する．
ここで，**人のテーブルを作る際，「名前」に主キーを設定するのは筋が良くない**

理由：同姓同名の人が存在する可能性があるから

解決策：**IDを付与**して，これを主キーとする

PostgreSQLの場合，
`CREATE TABLE`（テーブル作成）時に，`SERIAL`型で指定の変数（例　userid）のIDを自動作成し，`PRIMARY KEY`（主キー）を設定する．

各種型の説明：

- `VARCHAR(16)`
    - VAR + CHAR(16)ということ．つまり，最大16文字の可変長文字列型を定義
- `CHAR(1)`
    - 1文字の固定長文字列型を定義

日記本文は，文の長さが未知であったから`TEXT`型を指定したが，名前と性別はおおよそ文字長が絞り込めるので上記の型を選択した．

テーブルの定義を終えたら，各種データを入れていく．10節学習した`INSERT INTO`句を使う．


### [日記のテーブルをつくる]

- 日付は重複する場合があるから主キーになりえない
    - IDを作成する
- 日記内で「誰が書いたか」を表現するために，[人のテーブルを作ろう]で作成した`userid`情報を保存すれば良い．


### [2つのテーブルを確認しよう]

確認は，おなじみの
`SELECT * from <確認したいテーブル名>`
でできる．

上の2項目で作成したテーブルを比較する．前回作成した「日記とユーザデータを一纏めにしたテーブル」と比較して，IDとユーザ情報を設定することで，同姓同名の重複があった場合でも，対応できるようになった！

しかし，ID付与によって，日記に「性別」等の情報が明示されなくなったので，例えば男性が書いた日記を取り出したい場合は，
**テーブルの結合**という操作が必要になる．これは次回(12節)で解説される．


## 練習問題

「天気」，「職業」という項目を追加せよ．データモデリングの観点から2属性がどのようなものか考え，正しいテーブルに，正しいデータ型で反映すること．


### 答案

「天気」は日記に従属，「職業」は人に従属しているので，それぞれを`diaries`, `users`テーブルに属性として与えればよい．

<br>

1. `users`テーブルの作成

`CREATE TABLE users (userid SERIAL PRIMARY KEY, name VARCHAR(16), gender CHAR(1), job VARCHAR(16));`

という感じに追加する．職業は16文字程度あれば収まると想定

<br>

2. ユーザ情報の挿入

```
INSERT INTO users (name, gender, job) VALUES ('山田寝太郎', '男', '自宅警備員');
INSERT INTO users (name, gender, job) VALUES ('鈴木ひより', '女', 'ニート');
INSERT INTO users (name, gender, job) VALUES ('石垣高雄', '男', '家事手伝い');
```

という感じに挿入する

<br>

3. `diaries`テーブルの作成

`CREATE TABLE diaries (id SERIAL PRIMARY KEY, write_date DATE, body TEXT, whether CHAR(1), userid INTEGER);`

- whether
    - 晴
    - 曇
    - 雨
    - 雪
    - 雹

という感じに一文字で想定

<br>

4. 日記の挿入

```
INSERT INTO diaries (write_date, body, whether, userid) VALUES ('2018-02-25', 'よく寝た', '晴',1);
INSERT INTO diaries (write_date, body, whether, userid) VALUES ('2018-02-25', '何もしなかった', '曇',2);
INSERT INTO diaries (write_date, body, whether, userid) VALUES ('2018-02-26', '自宅を警備した', '雨',2);
```

という感じに挿入する．

<br>

5. 結果

```
> select * from users;
 userid |    name    | gender |    job
--------+------------+--------+------------
      1 | 山田寝太郎 | 男     | 自宅警備員
      2 | 鈴木ひより | 女     | ニート
      3 | 石垣高雄   | 男     | 家事手伝い
(3 rows)
```

```
> select * from diaries;
 id | write_date |      body      | whether | userid
----+------------+----------------+---------+--------
  1 | 2018-02-25 | よく寝た       | 晴      |      1
  2 | 2018-02-25 | 何もしなかった | 曇      |      2
  3 | 2018-02-26 | 自宅を警備した | 雨      |      2
(3 rows)
```

### 模範解答に対する改善点

大枠の考え方は正しいが，以下が不足している．

- 既存のテーブルに新たな属性（列）を追加する場合は次のクエリを投げれば良い．わざわざテーブルを消去する必要はない！
    - `ALTER TABLE <テーブル名> add <追加属性名> <型>`
    - 例　`ALTER TABLE users add job VARCHAR(16)`
- `weather` 属性
    - `晴れのち曇り`とか入れたい人を想定して，もう少し文字列を取るべき．そして可変長するのを忘れずに！

## 疑問点や不満点等

この節は全体的に，簡単に説明しようとして逆にわかりにくくなっている感，説明不足で混乱しがちな箇所がある．

### [1.エンティティを決める]

の解説がよくわからない

ER図では，
- diaries(日記のページ)
    - write_date(書いた日)
    - body(日記の内容)
という構成になっているが，[1.~]の解説ではwrite_date, bodyが「別のエンティティに付属する情報」としているのがよくわからない．ER図では，diariesエンティティに付属する情報として一纏めにしているのだから，別のエンティティに付属してなくない？


### [3.データとして持つ項目をまとめる]

のER図は割愛せずに最低限は説明してほしかった．説明がないと余計に混乱する（属性の左横に四角マークがついているのはなにか？，エンティティ間の線分下にある1, 0...はなにか,diariesエンティティのuserid(FK)のFKはなにか？とか．）


### [練習]
 
`ALTER TABLE`ってここまでで解説された？おそらくされていないハズ？10節でこの句も追加すべきでは？